---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  :init:
    desc: Initialize all dependencies
    cmd: |
      yq '.tasks | keys | .[] | select(. == "init-*")' {{.TASKFILE}} | while read task; do
        task init:${task#init-}
      done

  :init:*:
    desc: Initialize dependencies ["mise" | "python" | "ansible" | "k8s"]
    vars:
      DEP: "{{index .MATCH 0}}"
    cmds:
      - echo "Initializing dependencies for {{.DEP}}"
      - task: init-{{.DEP}}

  :update:
    desc: Update all dependencies
    cmds:
      - mise upgrade
      - kubectl krew update

  init-mise:
    internal: true
    desc: Initialize Mise
    cmds:
      - mise trust
      - mise install
    preconditions:
      - test -f {{.ROOT_DIR}}/.mise.toml
      - command -v mise >/dev/null

  init-python:
    internal: true
    desc: Initialize Python modules
    cmds:
      - uv pip install -r {{.ROOT_DIR}}/requirements.txt
    preconditions:
      - test -f {{.ROOT_DIR}}/requirements.txt
      - command -v uv >/dev/null

  init-ansible:
    internal: true
    desc: Initialize Ansible dependencies
    dir: "{{.ANSIBLE_DIR}}"
    cmds:
      - ansible-galaxy collection install -r requirements.yml -p "{{.ROOT_DIR}}/.cache/ansible/collections" --force
      - ansible-galaxy role install -r requirements.yml -p "{{.ROOT_DIR}}/.cache/ansible/roles" --force

  init-k8s:
    internal: true
    desc: Initialize helm and kubectl krew plugins
    cmds:
      - helm plugin install https://github.com/databus23/helm-diff
      - kubectl krew update
      - kubectl krew index add netshoot https://github.com/nilic/kubectl-netshoot.git || true
      - kubectl krew install netshoot/netshoot
      - kubectl krew install get-all
      - kubectl krew install tree
      - kubectl krew install browse-pvc
      - kubectl krew install rook-ceph
