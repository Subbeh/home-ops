---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  secret-ansible-key:
    internal: true
    cmds:
      - task: save
        vars:
          VALUE:
            sh: bwget ansible vault-key
          OUTPUT: "{{.PRIVATE_DIR}}/core/ansible_vault_key"

  secret-cloudflare-api:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/infra/cloudflare, SECRET: "api_token='{{.api_token}}' zone_id='{{.zone_id}}'" }
    vars:
      api_token:
        sh: task get:cloudflare.com:infra-api-token
      zone_id:
        sh: task get:cloudflare.com:zone-id

  secret-cloudflare-tunnel:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/infra/cloudflare-tunnel, SECRET: "{{.secret}}" }
    vars:
      api_token:
        sh: task get:cloudflare.com:infra-api-token
      zone_id:
        sh: task get:cloudflare.com:zone-id
      secret:
        sh: jq -r '"account_tag=\(.AccountTag) tunnel_secret=\(.TunnelSecret) tunnel_id=\(.TunnelID)"' {{.PRIVATE_DIR}}/kubernetes/cloudflare-tunnel.json

  secret-gluetun:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/infra/gluetun, SECRET: "control_server_key='{{.control_server_key}}' wg_private_key='{{.wg_private_key}}'" }
    vars:
      control_server_key:
        sh: task get:gluetun:control-server-key
      wg_private_key:
        sh: task get:protonvpn:wg-private-key

  secret-opnsense:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/infra/opnsense, SECRET: "key='{{.key}}' secret='{{.secret}}'" }
    vars:
      key:
        sh: source {{.PRIVATE_DIR}}/opnsense_monitoring_apikey.txt && echo "$key"
      secret:
        sh: source {{.PRIVATE_DIR}}/opnsense_monitoring_apikey.txt && echo "$secret"
    preconditions:
      - test -f {{.PRIVATE_DIR}}/opnsense_monitoring_apikey.txt

  secret-pve-monitoring:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/infra/pve-monitoring, SECRET: "user='monitoring@pve' token='monitoring-token' token_value='{{.token_value}}'" }
    vars:
      token_value:
        sh: task get:pve.sbbh.cloud:monitoring-token

  secret-kopia:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/infra/kopia, SECRET: "password='{{.password}}'" }
    vars:
      password:
        sh: task get:kopia:password
