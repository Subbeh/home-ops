---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  secret-alertmanager:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/alertmanager, SECRET: "pushover_token='{{.pushover_token}}' pushover_user_key='{{.pushover_user_key}}' heartbeat_url='{{.heartbeat_url}}'" }
    vars:
      pushover_token:
        sh: task secrets:get:pushover:api-token-cluster
      pushover_user_key:
        sh: task secrets:get:pushover:user-key
      heartbeat_url:
        sh: task secrets:get:healthchecks.io:heartbeat_url

  secret-github-deploy-key:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/github-deploy-key, SECRET: "identity='@{{.identity}}' known_hosts='{{.known_hosts}}'" }
    vars:
      identity: "{{.PRIVATE_DIR}}/kubernetes/github-deploy.key"
      known_hosts:
        sh: ssh-keyscan github.com
    preconditions:
      - test -f {{.identity}}

  secret-github-runner:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/github-runner, SECRET: "app_id='{{.app_id}}' app_installation_id='{{.app_installation_id}}' app_private_key=@{{.app_private_key}}" }
    vars:
      app_id:
        sh: task secrets:get:github.com:actions-app-id
      app_installation_id:
        sh: task secrets:get:github.com:actions-app-installation-id
      app_private_key: "{{.PRIVATE_DIR}}/kubernetes/home-ops-runner-sbbh.private-key.pem"
    preconditions:
      - test -f {{.app_private_key}}

  secret-github-status-token:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/github-status-token, SECRET: "token='{{.token}}'" }
    vars:
      token:
        sh: task secrets:get:github.com:flux-status-token

  secret-github-webhook-token:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/github-webhook-token, SECRET: "token='@{{.PRIVATE_DIR}}/kubernetes/github-webhook-token.txt'" }
    preconditions:
      - test -f {{.PRIVATE_DIR}}/kubernetes/github-webhook-token.txt

  secret-grafana:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/grafana, SECRET: "user='{{.user}}' password='{{.password}}'" }
    vars:
      user:
        sh: task secrets:get:grafana.sbbh.cloud:username
      password:
        sh: task secrets:get:grafana.sbbh.cloud:password

  secret-rook-ceph:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/rook-ceph, SECRET: "password='{{.password}}'" }
    vars:
      password:
        sh: task secrets:get:rook.sbbh.cloud:password
