---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  secret-alertmanager:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/alertmanager, SECRET: "pushover_token='{{.pushover_token}}' pushover_user_key='{{.pushover_user_key}}' heartbeat_url='{{.heartbeat_url}}'" }
    vars:
      pushover_token:
        sh: bwget pushover api-token
      pushover_user_key:
        sh: bwget pushover user-key
      heartbeat_url:
        sh: bwget healthchecks.io heartbeat_url

  secret-github-deploy-key:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/github-deploy-key, SECRET: "identity='@{{.identity}}' known_hosts='{{.known_hosts}}'" }
    vars:
      identity: "{{.PRIVATE_DIR}}/kubernetes/github-deploy.key"
      known_hosts:
        sh: ssh-keyscan github.com
    preconditions:
      - test -f {{.identity}}

  secret-github-runner:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/github-runner, SECRET: "app_id='{{.app_id}}' app_installation_id='{{.app_installation_id}}' app_private_key=@{{.PRIVATE_DIR}}/kubernetes/homelab-runner-sbbh.private-key.pem" }
    vars:
      app_id:
        sh: bwget github.com actions-app-id
      app_installation_id:
        sh: bwget github.com actions-app-installation-id
    preconditions:
      - test -f {{.PRIVATE_DIR}}/kubernetes/homelab-runner-sbbh.private-key.pem

  secret-github-status-token:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/github-status-token, SECRET: "token='{{.token}}'" }
    vars:
      token:
        sh: bwget github.com flux-status-token

  secret-github-webhook-token:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/github-webhook-token, SECRET: "token='@{{.PRIVATE_DIR}}/kubernetes/github-webhook-token.txt'" }
    preconditions:
      - test -f {{.PRIVATE_DIR}}/kubernetes/github-webhook-token.txt

  secret-grafana:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/grafana, SECRET: "user='{{.user}}' password='{{.password}}'" }
    vars:
      user:
        sh: bww get username grafana.sbbh.cloud
      password:
        sh: bww get password grafana.sbbh.cloud

  secret-restic:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/restic, SECRET: "password='{{.password}}'" }
    vars:
      password:
        sh: bww get password restic

  secret-rook-ceph:
    internal: true
    cmds:
      - task: vault
        vars: { PATH: ops/k8s/rook-ceph, SECRET: "password='{{.password}}'" }
    vars:
      password:
        sh: bww get password rook.sbbh.cloud
