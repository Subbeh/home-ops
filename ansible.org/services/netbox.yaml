---
netbox:
  host: vps
  container: &netbox_container
    image: docker.io/netboxcommunity/netbox:v4.4-3.4.1
    ports:
      - "8080:8080"
    env:
      SKIP_SUPERUSER: "false"
      SUPERUSER_NAME: "sysadm"
      SUPERUSER_EMAIL: "netbox@sbbh.cloud"
      SUPERUSER_PASSWORD: "{{ netbox_admin_password }}" # Store in vault!
      SUPERUSER_API_TOKEN: "{{ netbox_admin_api_token }}" # Optional
      ALLOWED_HOSTS: "{{ netbox_allowed_hosts | default('*') }}"
      API_TOKEN_PEPPER_1: "{{ netbox_api_token_pepper }}"
      CORS_ORIGIN_ALLOW_ALL: "True"
      DB_HOST: netbox_postgres
      DB_NAME: netbox
      DB_PASSWORD: "{{ netbox_db_password }}"
      DB_USER: netbox
      EMAIL_FROM: "{{ common_email_svc }}"
      EMAIL_PASSWORD: "{{ common_email_svc_pass }}"
      EMAIL_PORT: "587"
      EMAIL_SERVER: smtp.gmail.com
      EMAIL_TIMEOUT: "10"
      EMAIL_USERNAME: "{{ common_email_svc }}"
      EMAIL_USE_SSL: "false"
      EMAIL_USE_TLS: "true"
      GRAPHQL_ENABLED: "true"
      MEDIA_ROOT: /opt/netbox/netbox/media
      METRICS_ENABLED: "false"
      REDIS_CACHE_DATABASE: "1"
      REDIS_CACHE_HOST: netbox_redis_cache
      REDIS_CACHE_INSECURE_SKIP_TLS_VERIFY: "false"
      REDIS_CACHE_PASSWORD: "{{ netbox_redis_cache_password }}"
      REDIS_CACHE_SSL: "false"
      REDIS_DATABASE: "0"
      REDIS_HOST: netbox_redis
      REDIS_INSECURE_SKIP_TLS_VERIFY: "false"
      REDIS_PASSWORD: "{{ netbox_redis_password }}"
      REDIS_SSL: "false"
      RELEASE_CHECK_URL: https://api.github.com/repos/netbox-community/netbox/releases
      SECRET_KEY: "{{ netbox_secret_key }}"
      TIME_ZONE: "{{ common_timezone | default('UTC') }}"
      WEBHOOKS_ENABLED: "true"
      # Resource limits for 1 CPU / 2GB RAM VPS
      UNIT_PROCESSES: "1" # Single worker for 1 CPU core
      UNIT_MAX_REQUESTS: "5000" # Restart worker after N requests to prevent memory leaks
    user: "unit:root"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/login/ || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 3
      start_period: 90s
    volumes:
      - "{{ common_data_dir }}/netbox/config:/etc/netbox/config:z,ro"
      - "{{ common_data_dir }}/netbox/media:/opt/netbox/netbox/media"
      - "{{ common_data_dir }}/netbox/reports:/opt/netbox/netbox/reports"
      - "{{ common_data_dir }}/netbox/scripts:/opt/netbox/netbox/scripts"

  files:
    - src: netbox/configuration.py
      dest: "{{ common_data_dir }}/netbox/config/configuration.py"
      mode: "0644"
    - src: netbox/extra.py
      dest: "{{ common_data_dir }}/netbox/config/extra.py"
      mode: "0644"
    - src: netbox/plugins.py
      dest: "{{ common_data_dir }}/netbox/config/plugins.py"
      mode: "0644"

netbox_worker:
  host: vps
  container:
    <<: *netbox_container
    ports: []
    command:
      - /opt/netbox/venv/bin/python
      - /opt/netbox/netbox/manage.py
      - rqworker
    healthcheck:
      test: ["CMD-SHELL", "ps -aux | grep -v grep | grep -q rqworker || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 3
      start_period: 20s

netbox_postgres:
  host: vps
  container:
    image: docker.io/postgres:17-alpine
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -q -t 2 -d $POSTGRES_DB -U $POSTGRES_USER"]
      interval: 10s
      timeout: 30s
      retries: 5
      start_period: 20s
    env:
      POSTGRES_DB: netbox
      POSTGRES_PASSWORD: "{{ netbox_db_password }}"
      POSTGRES_USER: netbox
    volumes:
      - "{{ common_data_dir }}/netbox/postgres:/var/lib/postgresql/data"

netbox_redis:
  host: vps
  container:
    image: docker.io/valkey/valkey:8.1-alpine
    command:
      - sh
      - -c
      - valkey-server --appendonly yes --requirepass $REDIS_PASSWORD
    healthcheck:
      test: ["CMD-SHELL", '[ $(valkey-cli --pass "$REDIS_PASSWORD" ping) = ''PONG'' ]']
      interval: 1s
      timeout: 3s
      retries: 5
      start_period: 5s
    env:
      REDIS_PASSWORD: "{{ netbox_redis_password }}"
    volumes:
      - "{{ common_data_dir }}/netbox/redis:/data"

netbox_redis_cache:
  host: vps
  container:
    image: docker.io/valkey/valkey:8.1-alpine
    command:
      - sh
      - -c
      - valkey-server --requirepass $REDIS_PASSWORD
    healthcheck:
      test: ["CMD-SHELL", '[ $(valkey-cli --pass "$REDIS_PASSWORD" ping) = ''PONG'' ]']
      interval: 1s
      timeout: 3s
      retries: 5
      start_period: 5s
    env:
      REDIS_PASSWORD: "{{ netbox_redis_cache_password }}"
    volumes:
      - "{{ common_data_dir }}/netbox/redis-cache:/data"
