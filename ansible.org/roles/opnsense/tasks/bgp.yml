---
- name: Pulling existing config
  oxlorg.opnsense.list:
    target: frr_bgp_general

- name: Enable FRR routing
  oxlorg.opnsense.frr_general:
    enabled: true

- name: Configure BGP
  oxlorg.opnsense.frr_bgp_general:
    as_number: "{{ bgp.as_number }}"
    id: "{{ bgp.router_id }}"
    reload: false

- name: Configure BGP neighbors
  oxlorg.opnsense.frr_bgp_neighbor:
    as_number: "{{ bgp.remote_as_number }}"
    ip: "{{ hostvars[item].ip_addr | ansible.utils.ipaddr('address') }}"
    source_int: "{{ bgp.source_int }}"
    next_hop_self: true
    description: "{{ item }}"
    match_fields: ["ip", "description"]
    reload: false
  loop: "{{ bgp.neighbors }}"

- name: Reloading BGP config
  oxlorg.opnsense.reload:
    target: frr
