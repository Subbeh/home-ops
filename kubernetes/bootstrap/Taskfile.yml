---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  BOOTSTRAP_DIR: "{{.K8S_DIR}}/bootstrap"

tasks:
  ns:
    desc: Create Kubernetes namespaces
    silent: true
    cmd: |
      find "{{.K8S_DIR}}/apps" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | while IFS= read -r ns; do
        if ! kubectl create namespace "$ns" --dry-run=client -o yaml | kubectl apply --server-side -f -; then
          echo "ERROR: Failed to apply namespace $ns"
        fi
      done

  crds:
    desc: Apply Helmfile CRDs
    silent: true
    cmd: |
      if ! helmfile -f "{{.BOOTSTRAP_DIR}}/helmfile.d/00-crds.yaml" template -q | kubectl apply --server-side -f -; then
        echo "ERROR: Failed to apply CRDs"
      fi

  apps:
    desc: Apply Helmfile apps
    silent: true
    cmd: |
      if ! helmfile -f "{{.BOOTSTRAP_DIR}}/helmfile.d/01-apps.yaml" sync --hide-notes; then
        echo "ERROR: Failed to sync helmfile"
      fi

  vault:
    desc: Setup Kubernetes Vault authentication
    cmds:
      - task: vault:auth
      - task: vault:role
      - task: vault:resources
      - task: vault:token
    vars:
      K8S_HOST:
        sh: kubectl config view -o jsonpath='{.clusters[0].cluster.server}'
    preconditions:
      - vault status &>/dev/null

  vault:auth:
    desc: Enable kubernetes auth
    internal: true
    cmds:
      - vault auth list | grep -q "home-ops/" || vault auth enable -path=home-ops kubernetes
      - |
        vault write auth/home-ops/config \
          kubernetes_host="$(kubectl config view -o jsonpath='{.clusters[0].cluster.server}')" \
          kubernetes_ca_cert="$(kubectl config view --raw -o jsonpath='{.clusters[0].cluster.certificate-authority-data}' | base64 -d)"

  vault:role:
    desc: Create authentication role
    internal: true
    cmd: |
      vault write auth/home-ops/role/external-secrets \
        bound_service_account_names="external-secrets" \
        bound_service_account_namespaces="*" \
        policies="ops" \
        ttl=24h || echo "Role may already exist, continuing..."

  vault:resources:
    desc: Create Kubernetes resources
    internal: true
    cmd: kubectl apply -f {{.TASKFILE_DIR}}/../apps/external-secrets/external-secrets/app/vault/clustersecretstore.yaml
    preconditions:
      - test -f {{.TASKFILE_DIR}}/../apps/external-secrets/external-secrets/app/vault/clustersecretstore.yaml

  vault:token:
    desc: Configure serviceaccount token
    internal: true
    cmd: |
      until JWT_TOKEN=$(kubectl get secret external-secrets-token -n external-secrets -o jsonpath='{.data.token}' | base64 -d); do sleep 5; done
      vault write auth/home-ops/login role=external-secrets jwt="$JWT_TOKEN"

  github:preproc:
    desc: Prepare Github deploy key and webhook token
    cmds:
      - task: github:deploy-key:generate
      - task: github:deploy-key:upload
      - task: github:webhook-token:generate
      - task: github:secrets

  github:postproc:
    desc: Post processing after Flux provisioning
    cmds:
      - task: github:webhook

  github:deploy-key:generate:
    desc: Generate Github deploy key
    internal: true
    cmds:
      - mkdir -p "{{.PRIVATE_DIR}}/kubernetes"
      - ssh-keygen -t ecdsa -b 521 -C "flux-deploy-key" -f {{.DEPLOY_KEY}} -q -P ""
    vars:
      DEPLOY_KEY: "{{.PRIVATE_DIR}}/kubernetes/github-deploy.key"
    status:
      - test -f "{{.DEPLOY_KEY}}"

  github:deploy-key:upload:
    desc: Add or update deploy key in GitHub repository
    internal: true
    cmd: |
      if gh repo deploy-key list | grep -q "Flux Deploy Key"; then
        echo "Deploy key already exists, updating..."
        KEY_ID=$(gh repo deploy-key list --json id,title | jq -r '.[] | select(.title == "Flux Deploy Key") | .id')
        gh repo deploy-key delete $KEY_ID
      fi
      gh repo deploy-key add {{.DEPLOY_KEY}}.pub --title "Flux Deploy Key" --allow-write
    vars:
      DEPLOY_KEY: "{{.PRIVATE_DIR}}/kubernetes/github-deploy.key"
    preconditions:
      - test -f "{{.DEPLOY_KEY}}"

  github:webhook-token:generate:
    desc: Generate Github webhook token
    internal: true
    cmd: python -c "import secrets; print(secrets.token_hex(16), end='')" > "{{.WEBHOOK_TOKEN}}"
    vars:
      WEBHOOK_TOKEN: "{{.PRIVATE_DIR}}/kubernetes/github-webhook-token.txt"
    status:
      - test -f "{{.WEBHOOK_TOKEN}}"

  github:secrets:
    desc: Create Vault secrets
    internal: true
    dir: "{{.ROOT_DIR}}"
    cmds:
      - task secrets:create:github-deploy-key
      - task secrets:create:github-status-token

  github:webhook:
    desc: Add Flux receiver webhook to GitHub repository
    internal: true
    cmd: |
      echo "Waiting for GitHub webhook receiver and webhook path to be ready..."
      while true; do
        FLUX_WEBHOOK=$(kubectl -n flux-system get receiver github-webhook -o jsonpath='{.status.webhookPath}' 2>/dev/null)
        if [[ -n "$FLUX_WEBHOOK" ]]; then
          break
        fi
        echo "GitHub webhook receiver not ready, waiting 10 seconds..."
        sleep 10
      done
      echo "Webhook path: $FLUX_WEBHOOK"
      echo "Token: $(<{{.WEBHOOK_TOKEN}})"
      repo="$(git remote get-url origin | sed 's/.*:\([^\.]*\)\..*/\1/')"
      gh api \
        -X POST \
        -H "Accept: application/vnd.github+json" \
        /repos/$repo/hooks \
        --input - <<EOF
      {
        "name": "web",
        "active": true,
        "events": ["push"],
        "config": {
          "url": "https://flux-webhook.sbbh.cloud$FLUX_WEBHOOK",
          "content_type": "json",
          "secret": "$(<{{.WEBHOOK_TOKEN}})"
        }
      }
      EOF
    vars:
      WEBHOOK_TOKEN: "{{.PRIVATE_DIR}}/kubernetes/github-webhook-token.txt"
    preconditions:
      - test -f {{.WEBHOOK_TOKEN}}
