---
- name: Enable and set up Unbound
  oxlorg.opnsense.unbound_general: "{{ dns.unbound }}"
  delegate_to: localhost

- name: Enable DNS-over-TLS
  oxlorg.opnsense.unbound_dot: "{{ item }}"
  delegate_to: localhost
  loop: "{{ dns.unbound_dot }}"

- name: Add hostname overrides
  oxlorg.opnsense.unbound_host:
    hostname: "{{ item }}"
    domain: "{{ net_domain_loc }}"
    value: "{{ hostvars[item].ip_addr | ansible.utils.ipaddr('address') }}"
    match_fields: ['hostname']
    reload: false
  delegate_to: localhost
  when:
    - hostvars[item].ip_addr is defined
  loop: "{{ groups['all'] }}"

- name: Add manual host overrides
  oxlorg.opnsense.unbound_host:
    hostname: "{{ item.hostname }}"
    domain: "{{ item.domain }}"
    value: "{{ item.ip }}"
    description: "{{ item.description | default('') }}"
    match_fields: ['hostname']
    reload: false
  delegate_to: localhost
  loop: "{{ dns.host_overrides | default([]) }}"

- name: Add domain overrides
  oxlorg.opnsense.unbound_domain:
    domain: "{{ item.domain }}"
    server: "{{ item.server }}"
    description: "{{ item.description | default('') }}"
    match_fields: ['domain']
    reload: false
  delegate_to: localhost
  loop: "{{ dns.domain_overrides | default([]) }}"

- name: Add query forwarding
  oxlorg.opnsense.unbound_forward:
    domain: "{{ item.domain }}"
    target: "{{ item.target }}"
    reload: false
  delegate_to: localhost
  loop: "{{ dns.query_forwarding | default([]) }}"

- name: Reloading host overrides
  oxlorg.opnsense.reload:
    target: unbound
  delegate_to: localhost
